<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Chamados T.I</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.19.0/dist/umd/supabase.min.js"></script>
    
    <style>
        body { box-sizing: border-box; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Tema Escuro - Cor de fundo e texto */
        .dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e2e8f0; }
        .light-mode { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #1a202c; }
        /* Cores de Fundo de Card/Elemento */
        .dark-mode .bg-white, .dark-mode .bg-gray-100 { background-color: #2a314b; }
        .dark-mode .text-gray-900, .dark-mode .text-gray-700 { color: #e2e8f0; }
        .dark-mode .border-gray-200, .dark-mode .border-gray-300 { border-color: #4a5568; }
        /* Ajuste para inputs/selects no dark mode */
        .dark-mode input, .dark-mode select, .dark-mode textarea { background-color: #3b425e; border-color: #4a5568; color: #e2e8f0; }
        /* Estilização para o PDF gerado */
        #pdfContent { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            color: #333; /* Força cor escura para impressão */
        }
    </style>
</head>
<body class="min-h-screen transition-all duration-300 dark-mode">
    <header class="shadow-lg py-4 px-6 bg-white dark:bg-gray-800 fixed w-full z-10">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Sistema de Chamados T.I</h1>
            <nav class="space-x-4 flex items-center">
                <button id="authButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Login
                </button>
                <button id="themeToggle" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">
                    ☀️ Modo Escuro
                </button>
            </nav>
        </div>
    </header>

    <main id="appContent" class="pt-24 pb-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <div id="loadingIndicator" class="text-center text-lg text-white dark:text-gray-200">Carregando...</div>
    </main>

    <footer class="text-center py-4 text-sm text-gray-200 dark:text-gray-400">
        <p>&copy; 2024 Lucas Fragozo - Todos os direitos reservados.</p>
    </footer>


    <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Acesso ao Sistema</h3>
            <form id="loginForm" class="space-y-4">
                <input type="text" id="loginUsername" placeholder="Seu Usuário" required
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                <input type="password" id="loginPassword" placeholder="Sua Senha" required
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition-colors">
                    Entrar
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-3 text-center hidden">Erro de login. Tente novamente.</p>
        </div>
    </div>
    
    <div id="newTicketModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-lg">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Abrir Novo Chamado</h3>
            <form id="newTicketForm" class="space-y-4">
                <input type="text" id="requesterName" placeholder="Seu Nome/Empresa" required
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                <textarea id="ticketDescription" rows="4" placeholder="Descreva o problema em detalhes..." required
                          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Anexo (Opcional)</label>
                    <input type="file" id="ticketAttachment"
                           class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-indigo-900 dark:file:text-indigo-300 dark:file:hover:bg-indigo-800">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                        Abrir Chamado
                    </button>
                    <button type="button" id="cancelNewTicket" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Gerar Relatório de Chamados</h3>
            <div id="reportContent" class="text-gray-700 dark:text-gray-300 mb-4">
                <p>O relatório será gerado em PDF com todos os chamados dos últimos 30 dias.</p>
                <p class="mt-2 text-sm font-semibold">Os valores de cada chamado e o total serão incluídos.</p>
            </div>
            <div class="flex justify-end space-x-4">
                <button onclick="gerarRelatorioPDFLote()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-colors">
                    Gerar PDF (30 Dias)
                </button>
                <button type="button" onclick="document.getElementById('reportModal').classList.add('hidden')" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    
    <div id="setServiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Definir Serviço e Valor</h3>
            <form id="setServiceForm" class="space-y-4">
                <input type="hidden" id="serviceTicketId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Serviço Aplicado</label>
                    <select id="serviceSelect" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="">Selecione o Serviço Aplicado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor Final (R$)</label>
                    <input type="number" step="0.01" id="serviceValueInput" required 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" placeholder="0.00">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Ajuste o valor aqui. Útil para custos de peça ou horas extras de serviço.
                    </p>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">
                        Salvar Serviço e Valor
                    </button>
                    <button type="button" id="cancelSetService" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="pdfContainer" style="position: absolute; left: -9999px;">
        <div id="pdfContent"></div>
    </div>


    <script>
    // ------------------------------------------------------------------
    // 1. CONFIGURAÇÃO SUPABASE
    // ------------------------------------------------------------------
    const SUPABASE_URL = 'https://ezdzvblxyddwxreyowyh.supabase.co'; // Substitua pela sua URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6ZHp2Ymx4eWRkd3hyZXlvd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MzI3OTEsImV4cCI6MjA3NTAwODc5MX0._b0Vut7nJfhrIqekY8VItrpDrI23xRJ88z31rFUw4ls'; // Substitua pela sua Chave Anon
    
    // Inicializa o cliente Supabase
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variáveis de estado global
    let currentUser = null;
    let isAdmin = false;
    let availableServices = []; // Armazena a lista de serviços

    // ------------------------------------------------------------------
    // 2. FUNÇÕES GERAIS DE UI
    // ------------------------------------------------------------------
    const appContent = document.getElementById('appContent');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const authButton = document.getElementById('authButton');
    const themeToggle = document.getElementById('themeToggle');
    const loginModal = document.getElementById('loginModal');
    const newTicketModal = document.getElementById('newTicketModal');
    const reportModal = document.getElementById('reportModal');
    
    // Referências do DOM para o novo modal de serviço
    const setServiceModal = document.getElementById('setServiceModal');
    const serviceSelect = document.getElementById('serviceSelect');
    const serviceValueInput = document.getElementById('serviceValueInput');
    const serviceTicketId = document.getElementById('serviceTicketId');

    function showLoading() { loadingIndicator.classList.remove('hidden'); appContent.innerHTML = ''; }
    function hideLoading() { loadingIndicator.classList.add('hidden'); }
    
    function getStatusBadge(status) {
        let color, text;
        switch (status) {
            case 'open': color = 'bg-red-500'; text = 'Aberto'; break;
            case 'in_progress': color = 'bg-yellow-500'; text = 'Em Progresso'; break;
            case 'closed': color = 'bg-green-500'; text = 'Fechado'; break;
            default: color = 'bg-gray-500'; text = 'Desconhecido';
        }
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color} text-white">${text}</span>`;
    }

    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        return new Date(timestamp).toLocaleString('pt-BR');
    }
    
    function formatCurrency(value) {
        if (value === null || typeof value === 'undefined') return 'R$ 0,00';
        return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
    }

    // ------------------------------------------------------------------
    // 3. FUNÇÕES DE AUTENTICAÇÃO
    // ------------------------------------------------------------------

    // 3.1. Função para buscar a Role do usuário
    async function getRole() {
        if (!currentUser) return null;
        const { data, error } = await supabaseClient
            .from('users')
            .select('role')
            .eq('id', currentUser.id)
            .single();

        if (error) {
            console.error("Erro ao buscar role:", error);
            return null;
        }
        return data ? data.role : null;
    }

    // 3.2. Observador de Estado de Autenticação
    supabaseClient.auth.onAuthStateChange((event, session) => {
        if (session) {
            currentUser = session.user;
            getRole().then(role => {
                isAdmin = role === 'admin';
                authButton.textContent = 'Logout';
                authButton.onclick = handleLogout;
                renderApp();
            });
        } else {
            currentUser = null;
            isAdmin = false;
            authButton.textContent = 'Login';
            authButton.onclick = () => loginModal.classList.remove('hidden');
            renderApp();
        }
    });

    // 3.3. Função de Login
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDisplay = document.getElementById('loginError');
        errorDisplay.classList.add('hidden');

        showLoading();

        // 1. Busca o e-mail/ID no `users` baseado no `username`
        const { data: userData, error: userError } = await supabaseClient
            .from('users')
            .select('id')
            .eq('username', username)
            .single();
            
        if (userError || !userData) {
            hideLoading();
            errorDisplay.textContent = 'Usuário não encontrado.';
            errorDisplay.classList.remove('hidden');
            return;
        }

        // 2. Tenta fazer login com o ID (email) e senha
        const { error: authError } = await supabaseClient.auth.signInWithPassword({
            email: username, // Assumindo que o username é o email de login real
            password: password,
        });

        if (authError) {
            hideLoading();
            console.error("Erro de login:", authError);
            errorDisplay.textContent = 'Credenciais inválidas.';
            errorDisplay.classList.remove('hidden');
        } else {
            loginModal.classList.add('hidden');
            // O onAuthStateChange fará o resto
        }
    });

    // 3.4. Função de Logout
    async function handleLogout() {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
            console.error("Erro ao fazer logout:", error);
        }
    }

    // ------------------------------------------------------------------
    // 4. LÓGICA DO CLIENTE
    // ------------------------------------------------------------------

    // 4.1. Renderiza o Dashboard do Cliente
    async function loadClientDashboard() {
        showLoading();
        // MUDANÇA: Adiciona o service_value para o cliente ver o valor
        const userTickets = await fetchUserTickets(`
            id, protocol, requester, description, status, created_at, closed_at, service_value,
            ticket_attachments(attachment_url)
        `);

        let html = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-semibold text-white dark:text-gray-200">Meus Chamados</h2>
                <button id="openNewTicketModal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    + Abrir Novo Chamado
                </button>
            </div>
            ${userTickets.length === 0 ? 
                '<p class="text-center text-xl text-white dark:text-gray-300">Você não tem chamados abertos.</p>' : 
                `<div class="bg-white dark:bg-gray-800 shadow-xl rounded-xl overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Protocolo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Aberto Em</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Anexo</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            ${userTickets.map(ticket => `
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${ticket.protocol || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(ticket.status)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatDateTime(ticket.created_at)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">${formatCurrency(ticket.service_value)}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300 max-w-xs truncate">${ticket.description}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        ${ticket.attachment_url ? `<a href="${ticket.attachment_url}" target="_blank" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold">Ver Anexo</a>` : 'Nenhum'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`}
        `;

        appContent.innerHTML = html;
        hideLoading();
        
        document.getElementById('openNewTicketModal').addEventListener('click', () => newTicketModal.classList.remove('hidden'));
    }

    // 4.2. Busca Tickets do Usuário (Função reutilizada)
    async function fetchUserTickets(selectFields) {
        const { data, error } = await supabaseClient
            .from('tickets')
            .select(selectFields)
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Erro ao buscar tickets:", error);
            return [];
        }

        return data.map(ticket => ({
            ...ticket,
            attachment_url: ticket.ticket_attachments.length > 0 ? ticket.ticket_attachments[0].attachment_url : null
        }));
    }

    // 4.3. Lógica de Novo Chamado (SIMPLIFICADA)
    document.getElementById('newTicketForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const requester = document.getElementById('requesterName').value.trim();
        const description = document.getElementById('ticketDescription').value.trim();
        const attachmentFile = document.getElementById('ticketAttachment').files[0];

        const ticketData = {
            requester: requester,
            description: description,
            user_id: currentUser.id,
            protocol: `TICKET-${Date.now()}` 
            // service_id e service_value são definidos pelo Admin
        };

        // 1. Insere o ticket no BD
        const { data: insertedTicket, error: ticketError } = await supabaseClient
            .from('tickets')
            .insert(ticketData)
            .select()
            .single();

        if (ticketError) {
            alert('Erro ao abrir chamado: ' + ticketError.message);
            console.error("Erro ao inserir ticket:", ticketError);
            return;
        }

        // 2. Lógica de Upload de Anexo (se houver)
        if (attachmentFile) {
            const filePath = `${currentUser.id}/${insertedTicket.protocol}/${attachmentFile.name}`;
            const { error: uploadError } = await supabaseClient.storage
                .from('ticket_attachments')
                .upload(filePath, attachmentFile, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (uploadError) {
                alert('Chamado criado, mas erro ao fazer upload do anexo: ' + uploadError.message);
                console.error("Erro ao fazer upload:", uploadError);
            } else {
                // 3. Salva a URL do anexo no BD (tabela `ticket_attachments`)
                const { data: urlData } = supabaseClient.storage
                    .from('ticket_attachments')
                    .getPublicUrl(filePath);

                const { error: attachError } = await supabaseClient
                    .from('ticket_attachments')
                    .insert({
                        ticket_id: insertedTicket.id,
                        attachment_url: urlData.publicUrl,
                        uploaded_by: currentUser.id
                    });

                if (attachError) {
                    console.error("Erro ao salvar URL do anexo:", attachError);
                }
            }
        }

        // Sucesso
        newTicketModal.classList.add('hidden');
        document.getElementById('newTicketForm').reset();
        alert('Chamado aberto com sucesso! Protocolo: ' + insertedTicket.protocol);
        loadClientDashboard(); // Recarrega a lista
    });
    
    document.getElementById('cancelNewTicket').addEventListener('click', () => newTicketModal.classList.add('hidden'));

    // ------------------------------------------------------------------
    // 5. LÓGICA DO ADMIN
    // ------------------------------------------------------------------

    // 5.1. Função para carregar a lista de serviços
    async function fetchAvailableServices() {
        if (availableServices.length > 0) return; 
        const { data, error } = await supabaseClient
            .from('services')
            .select('id, service_name, price') // Seleciona ID e Price
            .order('id', { ascending: true });

        if (error) {
            console.error('Erro ao carregar lista de serviços:', error);
            return;
        }
        availableServices = data;
    }
    
    // 5.2. Função para mostrar o modal de serviço
    window.showSetServiceModal = function(ticketId) {
        const currentTicket = allTickets.find(t => t.id == ticketId);
        
        serviceTicketId.value = ticketId;
        // Preenche o valor e o service_id atual do ticket no modal (se já existirem)
        serviceValueInput.value = currentTicket.service_value ? parseFloat(currentTicket.service_value).toFixed(2) : '';

        // Preenche o <select> com os serviços disponíveis
        serviceSelect.innerHTML = '<option value="">Selecione o Serviço Aplicado</option>';
        availableServices.forEach(service => {
            const option = document.createElement('option');
            // MUDANÇA CRÍTICA: O value agora salva o ID e o preço, separados por '|'
            option.value = `${service.id}|${service.price}`; 
            option.textContent = `${service.service_name} (Base: ${formatCurrency(service.price)})`;
            
            // Pré-seleciona o serviço se ele já tiver sido definido
            if (currentTicket.service_id === service.id) {
                option.selected = true;
            }
            
            serviceSelect.appendChild(option);
        });
        
        setServiceModal.classList.remove('hidden');
    }

    // Preenche o input de valor ao selecionar o serviço
    serviceSelect.addEventListener('change', function() {
        const selectedValue = this.value; // Recebe "ID|Preço"
        if (selectedValue) {
            const price = selectedValue.split('|')[1];
            serviceValueInput.value = parseFloat(price).toFixed(2);
        } else {
            serviceValueInput.value = '';
        }
    });

    // Lógica de submissão do formulário de serviço
    document.getElementById('setServiceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const ticketId = serviceTicketId.value;
        const selectedValue = serviceSelect.value; // Recebe "ID|Preço"
        const serviceId = parseInt(selectedValue.split('|')[0]); // Pega o ID
        const value = parseFloat(serviceValueInput.value);

        if (isNaN(value) || value < 0) {
            alert('O valor do serviço não pode ser negativo.');
            return;
        }

        const updateData = { 
            service_value: value,
            service_id: serviceId // Salva o ID do serviço para futura referência
        };

        const { error } = await supabaseClient
            .from('tickets')
            .update(updateData)
            .eq('id', ticketId);

        if (error) {
            alert('Erro ao salvar o serviço e valor!');
            console.error('Erro ao salvar serviço:', error);
        } else {
            alert('Serviço e Valor salvos com sucesso!');
            setServiceModal.classList.add('hidden');
            loadAdminDashboard(); // Recarrega o painel admin
        }
    });

    document.getElementById('cancelSetService').addEventListener('click', () => setServiceModal.classList.add('hidden'));


    // 5.3. Renderiza o Dashboard do Admin (MUDANÇA CRÍTICA AQUI)
    let allTickets = [];

    async function loadAdminDashboard() {
        showLoading();
        await fetchAvailableServices(); 

        // MUDANÇA CRÍTICA: Inclui service_name na consulta
        const { data, error } = await supabaseClient
            .from('tickets')
            .select(`
                *, 
                users!inner(username), 
                ticket_attachments(attachment_url),
                services(service_name)
            `)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Erro ao buscar tickets admin:", error);
            appContent.innerHTML = `<p class="text-red-400">Erro ao carregar o painel administrativo.</p>`;
            hideLoading();
            return;
        }

        allTickets = data.map(ticket => ({
            ...ticket,
            requester_username: ticket.users.username,
            attachment_url: ticket.ticket_attachments.length > 0 ? ticket.ticket_attachments[0].attachment_url : null,
            // NOVO: Extrai o nome do serviço para exibição
            service_name: ticket.services ? ticket.services.service_name : null 
        }));

        let html = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-semibold text-white dark:text-gray-200">Painel Administrativo</h2>
                <button onclick="document.getElementById('reportModal').classList.remove('hidden')" 
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Gerar Relatório (30 Dias)
                </button>
            </div>
            ${allTickets.length === 0 ? 
                '<p class="text-center text-xl text-white dark:text-gray-300">Nenhum chamado registrado.</p>' : 
                `<div class="bg-white dark:bg-gray-800 shadow-xl rounded-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Protocolo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Aberto Por</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Serviço Aplicado</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            ${allTickets.map(ticket => {
                                const attachmentLink = ticket.attachment_url ? 
                                    `<a href="${ticket.attachment_url}" target="_blank" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold">Ver Anexo</a>` : 
                                    'Nenhum';
                                    
                                const serviceValue = formatCurrency(ticket.service_value);
                                
                                // NOVO: Exibe o nome do serviço ou 'A Definir'
                                const serviceNameDisplay = ticket.service_name 
                                    ? ticket.service_name 
                                    : `<span class="text-red-500">A Definir</span>`; 
                                
                                let actions = `<button onclick="showSetServiceModal('${ticket.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm mr-2 mb-1">Definir</button>`; 
                                
                                if (ticket.status === 'open') {
                                    actions += `<button onclick="updateTicketStatus('${ticket.id}', 'in_progress')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mr-2 mb-1">Progresso</button>`;
                                } else if (ticket.status === 'in_progress') {
                                    actions += `<button onclick="updateTicketStatus('${ticket.id}', 'closed')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm mr-2 mb-1">Fechar</button>`;
                                } else if (ticket.status === 'closed') {
                                    actions += `<button onclick="updateTicketStatus('${ticket.id}', 'open')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm mr-2 mb-1">Reabrir</button>`;
                                }
                                
                                return `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${ticket.protocol || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${ticket.requester_username} (${ticket.requester})</td>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">${serviceNameDisplay}</td> <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">${serviceValue}</td> 
                                        <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(ticket.status)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${actions}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`}
        `;

        appContent.innerHTML = html;
        hideLoading();
    }
    
    // 5.4. Função para atualizar o status do ticket
    window.updateTicketStatus = async function(ticketId, newStatus) {
        if (!confirm(`Tem certeza que deseja mudar o status para ${newStatus}?`)) return;

        const updateData = { status: newStatus };
        if (newStatus === 'closed') {
            updateData.closed_at = new Date().toISOString();
        } else if (newStatus === 'open') {
             updateData.closed_at = null; 
        }

        const { error } = await supabaseClient
            .from('tickets')
            .update(updateData)
            .eq('id', ticketId);

        if (error) {
            alert('Erro ao atualizar status!');
            console.error('Erro ao atualizar status:', error);
        } else {
            alert(`Status do chamado ${ticketId} atualizado para ${newStatus}.`);
            loadAdminDashboard();
        }
    }


    // ------------------------------------------------------------------
    // 6. GERAÇÃO DE RELATÓRIO PDF EM LOTE
    // ------------------------------------------------------------------

    // 6.1. Busca os tickets dos últimos 30 dias (MODIFICADO para incluir service_name)
    async function buscarTicketsUltimos30Dias() {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const { data, error } = await supabaseClient
            .from('tickets')
            .select(`
                *, 
                users!inner(username), 
                services(service_name)
            `)
            .gte('created_at', thirtyDaysAgo.toISOString()) 
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Erro ao buscar tickets para relatório:", error);
            alert('Erro ao buscar dados para o relatório.');
            return null;
        }

        return data.map(ticket => ({
            ...ticket,
            requester_username: ticket.users.username,
            service_name: ticket.services ? ticket.services.service_name : 'Serviço Não Definido'
        }));
    }

    // 6.2. Função principal de geração do PDF
    window.gerarRelatorioPDFLote = async function() {
        reportModal.classList.add('hidden');
        
        const tickets = await buscarTicketsUltimos30Dias();

        if (!tickets || tickets.length === 0) {
            alert('Nenhum chamado encontrado nos últimos 30 dias para gerar o relatório.');
            return;
        }

        const totalValue = tickets.reduce((sum, ticket) => {
            const value = parseFloat(ticket.service_value || 0);
            return sum + value;
        }, 0);
        const totalValueFormatted = formatCurrency(totalValue);

        const content = document.getElementById('pdfContent');
        content.innerHTML = ''; 

        // 1. Cria o cabeçalho do relatório com o total
        content.innerHTML = `
            <div style="text-align: center; border-bottom: 3px solid #3b82f6; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="color: #3b82f6; margin: 0; font-size: 1.8em;">RELATÓRIO CONSOLIDADO DE CHAMADOS</h1>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #4b5563;">CNPJ: 54.677.769/0001-78</p>
            </div>

            <h2 style="text-align: center; font-size: 1.2em; margin-top: 5px; color: #4b5563;">
                Últimos 30 Dias (Total: ${tickets.length} Chamados)
            </h2>
            <h3 style="text-align: center; font-size: 1.4em; color: #10b981; margin: 15px 0; padding: 10px; background-color: #e0f7fa; border-radius: 5px;">
                VALOR TOTAL CONSOLIDADO: ${totalValueFormatted}
            </h3>
            <p style="text-align: right; font-size: 0.8em; color: #6b7280;">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
        `;

        // 2. Itera sobre os tickets e adiciona ao conteúdo
        tickets.forEach((ticket, index) => {
            const createdAtDate = formatDateTime(ticket.created_at);
            const requesterName = ticket.requester_username; 
            const ticketDescription = ticket.description.length > 100 ? ticket.description.substring(0, 100) + '...' : ticket.description;
            
            let statusColor;
            let statusText;
            switch (ticket.status) {
                case 'open': statusColor = '#ef4444'; statusText = 'Aberto'; break;
                case 'in_progress': statusColor = '#f59e0b'; statusText = 'Em Progresso'; break;
                case 'closed': statusColor = '#10b981'; statusText = 'Fechado'; break;
                default: statusColor = '#6b7280'; statusText = 'Desconhecido';
            }
            
            const ticketValueFormatted = formatCurrency(ticket.service_value);

            const ticketHtml = `
                <div style="border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); page-break-inside: avoid;">
                    <p style="font-weight: bold; color: #1f2937; margin: 0 0 8px 0; border-bottom: 1px dotted #e5e7eb; padding-bottom: 5px;">
                        ${index + 1}. Protocolo: ${ticket.protocol} 
                        <span style="float: right; font-weight: normal; color: ${statusColor}; border: 1px solid ${statusColor}; padding: 3px 8px; border-radius: 4px; font-size: 0.8em;">${statusText}</span>
                    </p>
                    <div style="font-size: 0.9em; line-height: 1.5;">
                        <p style="margin: 2px 0;"><strong>Serviço Aplicado:</strong> ${ticket.service_name}</p>
                        <p style="margin: 2px 0;"><strong>Valor:</strong> <span style="font-weight: bold; color: #059669;">${ticketValueFormatted}</span></p>
                        <p style="margin: 2px 0;"><strong>Solicitante:</strong> ${requesterName} (${ticket.requester})</p>
                        <p style="margin: 2px 0;"><strong>Aberto em:</strong> ${createdAtDate}</p>
                        <p style="margin: 2px 0;"><strong>Descrição:</strong> ${ticketDescription}</p>
                    </div>
                </div>
            `;
            content.innerHTML += ticketHtml;
        });

        // 3. Rodapé
        content.innerHTML += `
            <div style="text-align: center; margin-top: 30px; border-top: 1px solid #e5e7eb; padding-top: 10px; font-size: 0.8em; color: #6b7280;">
                Documento gerado automaticamente pelo Sistema de Chamados T.I.
            </div>
        `;

        // 4. Gera e salva o PDF
        const options = {
            margin: 10,
            filename: `Relatorio_30Dias_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().from(content).set(options).save();
        alert('Relatório consolidado gerado com sucesso!');
    }


    // ------------------------------------------------------------------
    // 7. FUNÇÃO PRINCIPAL DE RENDERIZAÇÃO E TEMA
    // ------------------------------------------------------------------
    
    function renderApp() {
        if (currentUser) {
            loginModal.classList.add('hidden');
            if (isAdmin) {
                loadAdminDashboard();
            } else {
                loadClientDashboard();
            }
        } else {
            // Tela inicial sem login
            appContent.innerHTML = `
                <div class="text-center py-20 fade-in">
                    <h2 class="text-4xl font-extrabold text-white dark:text-gray-200 mb-4">Bem-vindo(a) ao Sistema de Chamados</h2>
                    <p class="text-xl text-white dark:text-gray-300 mb-8">Faça login para abrir ou gerenciar seus chamados.</p>
                    <button onclick="document.getElementById('loginModal').classList.remove('hidden')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 text-lg rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        Acessar Agora
                    </button>
                </div>
            `;
            hideLoading();
        }
    }

    // Função de Alternar Tema (já existente)
    themeToggle.addEventListener('click', () => {
        const isDarkMode = document.body.classList.contains('dark-mode');
        if (isDarkMode) {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
            themeToggle.textContent = '🌙 Modo Claro';
        } else {
            document.body.classList.remove('light-mode');
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '☀️ Modo Escuro';
        }
    });


    // Inicialização da aplicação
    supabaseClient.auth.getSession();
    
    </script>
</body>
</html>
