<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Sistema de Chamados T.I</title>
ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
ย ย <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.19.0/dist/umd/supabase.min.js"></script>
ย ยย
ย ย <style>
ย ย ย ย body { box-sizing: border-box; }
ย ย ย ย .fade-in { animation: fadeIn 0.3s ease-in; }
ย ย ย ย @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
ย ย ย ย .dark-mode { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e2e8f0; }
ย ย ย ย .light-mode { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #1a202c; }
ย ย </style>
</head>
<body class="min-h-screen transition-all duration-300 dark-mode">
ย ยย
ย ย <header class="bg-gray-800 shadow-lg p-4 sticky top-0 z-10">
ย ย ย ย <div class="max-w-7xl mx-auto flex justify-between items-center">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <h1 class="text-2xl font-bold text-white">SISTEMA DE CHAMADOS T.I</h1>
ย ย ย ย ย ย ย ย <p class="text-gray-300 text-sm">CNPJ: 54.677.769/0001-78</p>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="flex items-center space-x-4">
ย ย ย ย ย ย ย ย <button id="themeToggle" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ๐ Modo Claro
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย Sair
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </header>

ย ย <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
ย ย ย ย ย ย <div class="text-center mb-8">
ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Acesso ao Sistema</h2>
ย ย ย ย ย ย ย ย <p class="text-gray-600 dark:text-gray-300">Entre com suas credenciais</p>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <form id="loginForm" class="space-y-6">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Usuรกrio (Email)</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="username" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
ย ย ย ย ย ย ย ย ย ย <input type="password" id="password" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">
ย ย ย ย ย ย ย ย ย ย Entrar
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="adminDashboard" class="hidden">
ย ย ย ย <div class="max-w-7xl mx-auto p-6">
ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
ย ย ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Chamados Abertos</h3>
ย ย ย ย ย ย ย ย ย ย <p id="openTicketsCount" class="text-3xl font-bold text-blue-600">0</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Chamados Encerrados</h3>
ย ย ย ย ย ย ย ย ย ย <p id="closedTicketsCount" class="text-3xl font-bold text-green-600">0</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Total de Usuรกrios</h3>
ย ย ย ย ย ย ย ย ย ย <p id="usersCount" class="text-3xl font-bold text-purple-600">0</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Aรงรตes Administrativas</h3>
ย ย ย ย ย ย ย ย <div class="flex flex-wrap gap-4">
ย ย ย ย ย ย ย ย ย ย <button id="createUserBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย + Criar Usuรกrio (Cliente)
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button id="generateReportBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย ๐ Gerar Relatรณrio 30 Dias
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
ย ย ย ย ย ย ย ย <div class="p-6 border-b border-gray-200 dark:border-gray-700">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white">Gerenciar Chamados</h3>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="overflow-x-auto">
ย ย ย ย ย ย ย ย ย ย <table class="w-full">
ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-gray-50 dark:bg-gray-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Protocolo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Solicitante</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Descriรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Serviรงo</th> ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Valor</th> ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Anexo</th>ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data/Hora</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="adminTicketsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="clientDashboard" class="hidden">
ย ย ย ย <div class="max-w-4xl mx-auto p-6">
ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Abrir Novo Chamado</h3>
ย ย ย ย ย ย ย ย <button id="newTicketBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย + Novo Chamado
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
ย ย ย ย ย ย ย ย <div class="p-6 border-b border-gray-200 dark:border-gray-700">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white">Meus Chamados</h3>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div id="clientTicketsList" class="p-6">
ย ย ย ย ย ย ย ย ย ย <p class="text-gray-500 dark:text-gray-400">Nenhum chamado encontrado. Clique em "+ Novo Chamado" para comeรงar.</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Criar Novo Usuรกrio Cliente</h3>
ย ย ย ย ย ย <form id="createUserForm" class="space-y-4">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome de Usuรกrio</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="newUsername" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
ย ย ย ย ย ย ย ย ย ย <input type="email" id="newEmail" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" placeholder="ex: cliente@dominio.com">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
ย ย ย ย ย ย ย ย ย ย <input type="password" id="newPassword" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div class="flex space-x-4">
ย ย ย ย ย ย ย ย ย ย <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย Criar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button type="button" id="cancelCreateUser" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="newTicketModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Abrir Novo Chamado</h3>
ย ย ย ย ย ย <form id="newTicketForm" class="space-y-4">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Seu Nome/Departamento</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="requesterName" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" placeholder="Ex: Joรฃo - Financeiro">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descriรงรฃo do Problema</label>
ย ย ย ย ย ย ย ย ย ย <textarea id="ticketDescription" rows="4" requiredย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" placeholder="Detalhe o mรกximo possรญvel o erro ou solicitaรงรฃo."></textarea>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Anexar Arquivo (Opcional - Mรกx. 5MB)</label>
ย ย ย ย ย ย ย ย ย ย <input type="file" id="ticketAttachment"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-150"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยaccept=".jpg, .jpeg, .png, .pdf, .doc, .docx">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="flex space-x-4">
ย ย ย ย ย ย ย ย ย ย <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย Enviar Chamado
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button type="button" id="cancelNewTicket" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>
ย ยย
ย ย <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Gerar Relatรณrio</h3>
ย ย ย ย ย ย <p class="text-gray-600 dark:text-gray-300 mb-4">Serรก gerado um relatรณrio consolidado com todos os chamados dos รบltimos 30 dias.</p>
ย ย ย ย ย ย <div class="flex space-x-4">
ย ย ย ย ย ย ย ย <button id="confirmGeneratePDF" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย Confirmar e Gerar PDF
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย <button id="cancelReport" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย ย ย <div id="setServiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Definir Serviรงo e Valor</h3>
ย ย ย ย ย ย <form id="setServiceForm" class="space-y-4">
ย ย ย ย ย ย ย ย <input type="hidden" id="serviceTicketId">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Serviรงo</label>
ย ย ย ย ย ย ย ย ย ย <select id="serviceTypeSelect" required
ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor Cobrado (R$)</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" id="serviceValueInput" required
ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" placeholder="Ex: 150,00 ou 80,00 + Valor da peรงa">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="flex space-x-4">
ย ย ย ย ย ย ย ย ย ย <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย Salvar Serviรงo
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button type="button" id="cancelSetService" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
ย ย ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>
ย ย ย ย <footer class="bg-gray-800 text-white p-6 mt-12">
ย ย ย ย <div class="max-w-7xl mx-auto text-center">
ย ย ย ย ย ย <h4 class="text-lg font-semibold mb-4">Contatos para Suporte</h4>
ย ย ย ย ย ย <div class="flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-8">
ย ย ย ย ย ย ย ย <div class="flex items-center space-x-2">
ย ย ย ย ย ย ย ย ย ย <span>๐ง</span>
ย ย ย ย ย ย ย ย ย ย <a href="mailto:lfragozo563@gmail.com" class="hover:text-blue-400 transition-colors">lfragozo563@gmail.com</a>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="flex items-center space-x-2">
ย ย ย ย ย ย ย ย ย ย <span>๐ฑ</span>
ย ย ย ย ย ย ย ย ย ย <a href="tel:+5551993525004" class="hover:text-blue-400 transition-colors">51 99352-5004</a>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </footer>

<script>
ย ย // Configuraรงรฃo do Supabase
ย ย const supabaseUrl = 'https://ezdzvblxyddwxreyowyh.supabase.co';
ย ย // ๐ IMPORTANTE: SUBSTITUA 'SUA_CHAVE_ANON_AQUI' PELA CHAVE ANON REAL DO SEU PROJETO
ย ย const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6ZHp2Ymx4eWRkd3hyZXlvd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MzI3OTEsImV4cCI6MjA3NTAwODc5MX0._b0Vut7nJfhrIqekY8VItrpDrI23xRJ88z31rFUw4ls';ย

ย ย // Inicializaรงรฃo do Supabase
ย ย const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);ย

ย ย let currentUser = null;
ย ยย
ย ย // Referรชncias do DOM
ย ย const loginScreen = document.getElementById('loginScreen');
ย ย const adminDashboard = document.getElementById('adminDashboard');
ย ย const clientDashboard = document.getElementById('clientDashboard');
ย ย const createUserModal = document.getElementById('createUserModal');
ย ย const newTicketModal = document.getElementById('newTicketModal');
ย ย const reportModal = document.getElementById('reportModal');
ย ย const generateReportBtn = document.getElementById('generateReportBtn');
ย ย const confirmGeneratePDF = document.getElementById('confirmGeneratePDF');
ย ย const themeToggle = document.getElementById('themeToggle');

ย ย // NOVAS REFERรNCIAS DO MODAL DE SERVIรO
ย ย const setServiceModal = document.getElementById('setServiceModal');
ย ย const serviceTypeSelect = document.getElementById('serviceTypeSelect');
ย ย const serviceValueInput = document.getElementById('serviceValueInput');
ย ย const serviceTicketId = document.getElementById('serviceTicketId');

ย ย // LISTA DE SERVIรOS E VALORES (EXTRAรDA DA PROPOSTA PDF) 
ย ย const SERVICES_LIST = [
ย ย ย ย { name: "Formataรงรฃo de computador/notebook + Configuraรงรฃo", value: "R$ 150,00" },
ย ย ย ย { name: "Configuraรงรฃo de computador/notebook para uso empresarial", value: "R$ 50,00" },
ย ย ย ย { name: "Manutenรงรฃo em computador", value: "R$ 50,00 + Valor da peรงa" },
ย ย ย ย { name: "Manutenรงรฃo em notebook", value: "R$ 80,00 + Valor da peรงa" },
ย ย ย ย { name: "Configuraรงรตes de rede e impressora", value: "R$ 50,00 por Hora" },
ย ย ย ย { name: "Deslocamento de suporte presencial em Guaรญba", value: "R$ 10,00" },
ย ย ย ย { name: "Deslocamento de suporte presencial em Canoas", value: "R$ 80,00" },
ย ย ย ย { name: "Suporte remoto via anydesk", value: "R$ 250,00 Mensais sem limites de horas." }
ย ย ];


ย ย // Funรงรฃo auxiliar para mostrar o dashboard correto
ย ย function showDashboard(role) {
ย ย ย ย loginScreen.classList.add('hidden');
ย ย ย ย adminDashboard.classList.add('hidden');
ย ย ย ย clientDashboard.classList.add('hidden');

ย ย ย ย if (role === 'admin') {
ย ย ย ย ย ย adminDashboard.classList.add('fade-in');
ย ย ย ย ย ย adminDashboard.classList.remove('hidden');
ย ย ย ย ย ย loadAdminDashboard();
ย ย ย ย } else if (role === 'client') {
ย ย ย ย ย ย clientDashboard.classList.add('fade-in');
ย ย ย ย ย ย clientDashboard.classList.remove('hidden');
ย ย ย ย ย ย loadClientDashboard();
ย ย ย ย }
ย ย ย ย document.body.scrollTop = document.documentElement.scrollTop = 0;
ย ย }
ย ยย
ย ย // ------------------------------------------------------------------
ย ย // 1. FUNรรES DE LOGIN E AUTENTICAรรO
ย ย // ------------------------------------------------------------------
ย ย document.getElementById('loginForm').addEventListener('submit', async function(e) {
ย ย ย ย e.preventDefault();
ย ย ย ยย
ย ย ย ย const email = document.getElementById('username').value;ย
ย ย ย ย const password = document.getElementById('password').value;

ย ย ย ย // Tenta o LOGIN PADRรO
ย ย ย ย const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
ย ย ย ย ย ย email: email,ย
ย ย ย ย ย ย password: password,
ย ย ย ย });

ย ย ย ย if (authError) {
ย ย ย ย ย ย alert('Usuรกrio ou senha incorretos! Verifique as credenciais e a chave API no cรณdigo.');
ย ย ย ย ย ย console.error("Auth Error:", authError.message);
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย // Busca o ROLE do usuรกrio
ย ย ย ย const userId = authData.user.id;
ย ย ย ย await fetchUserRole(userId);
ย ย });

ย ย // Logout
ย ย document.getElementById('logoutBtn').addEventListener('click', async function() {
ย ย ย ย await supabaseClient.auth.signOut();
ย ย ย ย currentUser = null;
ย ย ย ย loginScreen.classList.remove('hidden');
ย ย ย ย adminDashboard.classList.add('hidden');
ย ย ย ย clientDashboard.classList.add('hidden');
ย ย ย ย document.getElementById('loginForm').reset();
ย ย ย ย document.body.scrollTop = document.documentElement.scrollTop = 0;
ย ย });
ย ยย
ย ย // Busca o ROLE e redireciona (Reutilizรกvel para login e verificaรงรฃo de sessรฃo)
ย ย async function fetchUserRole(userId) {
ย ย ย ย const { data: userData, error: userError } = await supabaseClient
ย ย ย ย ย ย .from('users')
ย ย ย ย ย ย .select('role, username')
ย ย ย ย ย ย .eq('id', userId)
ย ย ย ย ย ย .single();
ย ย ย ยย
ย ย ย ย if (userError || !userData) {
ย ย ย ย ย ย alert('Perfil de usuรกrio (role) nรฃo encontrado. Verifique a vinculaรงรฃo do UUID na sua tabela "users".');
ย ย ย ย ย ย await supabaseClient.auth.signOut();
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const session = (await supabaseClient.auth.getSession()).data.session;
ย ย ย ย currentUser = session.user; // Obtรฉm o objeto user completo
ย ย ย ย currentUser.user_metadata = { role: userData.role, username: userData.username };
ย ย ย ย showDashboard(userData.role);
ย ย }
ย ยย
ย ย // Verifica a sessรฃo ao carregar a pรกgina
ย ย async function checkSession() {
ย ย ย ย const { data: { session } } = await supabaseClient.auth.getSession();
ย ย ย ย if (session) {
ย ย ย ย ย ย currentUser = session.user;
ย ย ย ย ย ย await fetchUserRole(currentUser.id);
ย ย ย ย } else {
ย ย ย ย ย ย loginScreen.classList.remove('hidden');
ย ย ย ย }
ย ย }
ย ยย
ย ย // ------------------------------------------------------------------
ย ย // 2. FUNรรES DE DASHBOARD E CARREGAMENTO
ย ย // ------------------------------------------------------------------
ย ย async function loadAdminDashboard() {
ย ย ย ย await loadAdminTickets();
ย ย ย ย const { count: openCount } = await supabaseClient.from('tickets').select('*', { count: 'exact', head: true }).eq('status', 'open');
ย ย ย ย const { count: closedCount } = await supabaseClient.from('tickets').select('*', { count: 'exact', head: true }).eq('status', 'closed');
ย ย ย ย const { count: usersCount } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).eq('role', 'client');
ย ย ย ยย
ย ย ย ย document.getElementById('openTicketsCount').textContent = openCount || 0;ย
ย ย ย ย document.getElementById('closedTicketsCount').textContent = closedCount || 0;
ย ย ย ย document.getElementById('usersCount').textContent = usersCount || 0;
ย ย }

ย ย async function loadClientDashboard() {
ย ย ย ย loadClientTickets();
ย ย ย ย // Preenche o campo de solicitante automaticamente
ย ย ย ย if (currentUser && currentUser.user_metadata.username) {
ย ย ย ย ย ย ยdocument.getElementById('requesterName').value = currentUser.user_metadata.username;
ย ย ย ย }
ย ย }
ย ยย
ย ย // Carregamento de tickets do Admin
ย ย async function loadAdminTickets() {
ย ย ย ย const { data: tickets, error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .select('*')
ย ย ย ย ย ย .order('created_at', { ascending: false });

ย ย ย ย if (error) {
ย ย ย ย ย ย console.error('Erro ao carregar chamados:', error);
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const tbody = document.getElementById('adminTicketsList');
ย ย ย ย tbody.innerHTML = '';
ย ย ย ยย
ย ย ย ย const getStatusBadge = (status) => {
ย ย ย ย ย ย switch(status) {
ย ย ย ย ย ย ย ย case 'open': return '<span class="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full">Aberto</span>';
ย ย ย ย ย ย ย ย case 'in_progress': return '<span class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full">Em Progresso</span>';
ย ย ย ย ย ย ย ย case 'closed': return '<span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">Encerrado</span>';
ย ย ย ย ย ย ย ย default: return '';
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย tickets.forEach(ticket => {
ย ย ย ย ย ย const row = document.createElement('tr');
ย ย ย ย ย ย row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
ย ย ย ย ย ย const statusBadge = getStatusBadge(ticket.status);
ย ย ย ย ย ยย
ย ย ย ย ย ย let actions = '';

ย ย ย ย ย ย // Botรฃo de definir serviรงo (Aparece se nรฃo estiver encerrado)
ย ย ย ย ย ย if (ticket.status !== 'closed') {
ย ย ย ย ย ย ย ย actions += `<button onclick="openSetServiceModal('${ticket.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm mr-2">Serviรงo</button>`;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย if (ticket.status === 'open') {
ย ย ย ย ย ย ย ย actions += `<button onclick="startTicket('${ticket.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mr-2">Iniciar</button>`;
ย ย ย ย ย ย }

ย ย ย ย ย ย if (ticket.status === 'open' || ticket.status === 'in_progress') {
ย ย ย ย ย ย ย ย actions += `<button onclick="closeTicket('${ticket.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm mr-2">Encerrar</button>`;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // Botรฃo PDF Individual
ย ย ย ย ย ย actions += `<button onclick="generateTicketPDF('${ticket.id}')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm mr-2">PDF</button>`;

ย ย ย ย ย ย actions += `<button onclick="deleteTicket('${ticket.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Excluir</button>`;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Lรณgica para exibir o link de anexo
ย ย ย ย ย ย const attachmentLink = ticket.attachment_urlย
ย ย ย ย ย ย ย ย ? `<a href="${ticket.attachment_url}" target="_blank" class="text-blue-500 hover:text-blue-700 transition-colors">๐ Ver Anexo</a>`
ย ย ย ย ย ย ย ย : 'N/A';

ย ย ย ย ย ย // Lรณgica para exibir o Serviรงo e Valor
ย ย ย ย ย ย const serviceTypeDisplay = ticket.service_type || 'A definir';
ย ย ย ย ย ย const serviceValueDisplay = ticket.service_value || 'N/A';
ย ย ย ย ย ย const serviceColor = ticket.service_type ? 'text-green-600 dark:text-green-400 font-semibold' : 'text-red-600 dark:text-red-400';


ย ย ย ย ย ย row.innerHTML = `
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${ticket.protocol || 'N/A'}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${ticket.requester}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300 max-w-xs truncate">${ticket.description}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 text-sm ${serviceColor}">${serviceTypeDisplay}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap text-sm ${serviceColor}">${serviceValueDisplay}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap text-sm">${attachmentLink}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(ticket.status)}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${new Date(ticket.created_at).toLocaleString('pt-BR')}</td>
ย ย ย ย ย ย ย ย <td class="px-6 py-4 whitespace-nowrap text-sm">${actions}</td>
ย ย ย ย ย ย `;
ย ย ย ย ย ยย
ย ย ย ย ย ย tbody.appendChild(row);
ย ย ย ย });
ย ย }

ย ย // Carregamento de tickets do Cliente (Implementaรงรฃo bรกsica)
ย ย async function loadClientTickets() {
ย ย ย ย if (!currentUser || !currentUser.id) return;

ย ย ย ย const { data: tickets, error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .select('*')
ย ย ย ย ย ย .eq('user_id', currentUser.id)
ย ย ย ย ย ย .order('created_at', { ascending: false });

ย ย ย ย if (error) {
ย ย ย ย ย ย console.error('Erro ao carregar seus chamados:', error);
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const listDiv = document.getElementById('clientTicketsList');
ย ย ย ย listDiv.innerHTML = '';
ย ย ย ยย
ย ย ย ย if (tickets.length === 0) {
ย ย ย ย ย ย listDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Vocรช nรฃo tem chamados abertos ou histรณricos.</p>';
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย // Lรณgica de exibiรงรฃo simples para o cliente
ย ย ย ย tickets.forEach(ticket => {
ย ย ย ย ย ย ยconst statusColor = ticket.status === 'closed' ? 'bg-green-100 text-green-800' : (ticket.status === 'open' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800');
ย ย ย ย ย ย ย
ย ย ย ย ย ย ยconst attachmentHtml = ticket.attachment_urlย
ย ย ย ย ย ย ย ย ย? `<a href="${ticket.attachment_url}" target="_blank" class="text-sm text-blue-500 hover:underline">Ver Anexo</a>`
ย ย ย ย ย ย ย ย ย: '';
            
            // Exibir Serviรงo e Valor se jรก definidos
            const serviceInfo = ticket.service_type 
                ? `<p class="text-sm text-gray-700 dark:text-gray-200 mt-2">Serviรงo: <span class="font-medium">${ticket.service_type}</span></p>
                   <p class="text-sm text-gray-700 dark:text-gray-200">Valor: <span class="font-medium">${ticket.service_value}</span></p>`
                : '<p class="text-sm text-red-500 mt-2">Serviรงo e Valor ainda nรฃo definidos pelo Admin.</p>';

ย ย ย ย ย ย ยlistDiv.innerHTML += `
ย ย ย ย ย ย ย ย ย<div class="p-4 mb-4 border rounded-lg shadow dark:bg-gray-700 dark:border-gray-600">
ย ย ย ย ย ย ย ย ย ย ย<div class="flex justify-between items-center mb-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย<h4 class="font-bold text-gray-900 dark:text-white">Protocolo: ${ticket.protocol}</h4>
ย ย ย ย ย ย ย ย ย ย ย ย ย<span class="px-2 py-1 text-xs font-semibold ${statusColor} rounded-full">${ticket.status.toUpperCase().replace('_', ' ')}</span>
ย ย ย ย ย ย ย ย ย ย ย</div>
ย ย ย ย ย ย ย ย ย ย ย<p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${ticket.description}</p>
                       ${serviceInfo}
ย ย ย ย ย ย ย ย ย ย ย<div class="flex justify-between items-center text-xs text-gray-400 mt-2 border-t pt-2 dark:border-gray-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย<p>Aberto em: ${new Date(ticket.created_at).toLocaleString('pt-BR')}</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย${attachmentHtml}ย
ย ย ย ย ย ย ย ย ย ย ย</div>
ย ย ย ย ย ย ย ย ย</div>
ย ย ย ย ย ย ย`;
ย ย ย ย });
ย ย }


ย ย // Funรงรตes de Aรงรฃo do Ticket (startTicket, closeTicket, deleteTicket)
ย ย async function startTicket(ticketId) {
ย ย ย ย if (!confirm('Iniciar este chamado?')) return;
ย ย ย ย const { error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .update({ status: 'in_progress' })
ย ย ย ย ย ย .eq('id', ticketId);

ย ย ย ย if (error) {
ย ย ย ย ย ย alert('Erro ao iniciar chamado!');
ย ย ย ย } else {
ย ย ย ย ย ย alert('Chamado iniciado!');
ย ย ย ย ย ย loadAdminDashboard();
ย ย ย ย }
ย ย }

ย ย async function closeTicket(ticketId) {
ย ย ย ย if (!confirm('Encerrar este chamado?')) return;
ย ย ย ย const { error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .update({ status: 'closed', closed_at: new Date().toISOString() })
ย ย ย ย ย ย .eq('id', ticketId);

ย ย ย ย if (error) {
ย ย ย ย ย ย alert('Erro ao fechar chamado!');
ย ย ย ย } else {
ย ย ย ย ย ย alert('Chamado encerrado com sucesso!');
ย ย ย ย ย ย loadAdminDashboard();
ย ย ย ย }
ย ย }

ย ย async function deleteTicket(ticketId) {
ย ย ย ย if (!confirm('Tem certeza que deseja excluir este chamado?')) return;
ย ย ย ยย
ย ย ย ย // ๐ Lรณgica para deletar o arquivo anexo no Storage (deixada para futura implementaรงรฃo)
ย ย ย ยย
ย ย ย ย const { error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .delete()
ย ย ย ย ย ย .eq('id', ticketId);

ย ย ย ย if (error) {
ย ย ย ย ย ย alert('Erro ao excluir chamado!');
ย ย ย ย } else {
ย ย ย ย ย ย alert('Chamado excluรญdo com sucesso!');
ย ย ย ย ย ย loadAdminDashboard();
ย ย ย ย }
ย ย }
ย ยย
ย ย // TORNA AS FUNรรES DE AรรO GLOBAIS PARA QUE O ONCLICK FUNCIONE NA TABELA
ย ย window.startTicket = startTicket;
ย ย window.closeTicket = closeTicket;
ย ย window.deleteTicket = deleteTicket;
    
    // ------------------------------------------------------------------
    // NOVAS FUNรรES: DEFINIR SERVIรO (ADMIN)
    // ------------------------------------------------------------------

    // Funรงรฃo para preencher o dropdown de serviรงos com base na lista de preรงos
    function populateServiceSelect() {
        serviceTypeSelect.innerHTML = '<option value="" data-default-value="" selected disabled>Selecione o Serviรงo...</option>';
        SERVICES_LIST.forEach(service => {
            const option = document.createElement('option');
            option.value = service.name;
            option.textContent = service.name;
            option.dataset.defaultValue = service.value; // Armazena o valor padrรฃo
            serviceTypeSelect.appendChild(option);
        });
    }

    // Handler para preencher o campo de Valor automaticamente ao selecionar o Serviรงo
    serviceTypeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        // Preenche o input de valor com o valor padrรฃo do serviรงo selecionado
        serviceValueInput.value = selectedOption.dataset.defaultValue; 
    });


    // Funรงรฃo para abrir o modal de definiรงรฃo de serviรงo
    async function openSetServiceModal(ticketId) {
        if (!currentUser || currentUser.user_metadata.role !== 'admin') return;

        // 1. Preenche o dropdown (se ainda nรฃo preenchido)
        if (serviceTypeSelect.options.length <= 1) {
            populateServiceSelect();
        }

        // 2. Busca dados do ticket para prรฉ-preencher
        const { data: ticket, error } = await supabaseClient
            .from('tickets')
            .select('service_type, service_value')
            .eq('id', ticketId)
            .single();

        if (error) {
            console.error('Erro ao buscar ticket para serviรงo:', error);
            alert('Erro ao carregar dados do chamado.');
            return;
        }

        // 3. Preenche campos
        serviceTicketId.value = ticketId;
        serviceValueInput.value = ticket.service_value || '';
        
        // Seleciona o serviรงo atual (se existir)
        if (ticket.service_type) {
            serviceTypeSelect.value = ticket.service_type;
        } else {
            serviceTypeSelect.value = ""; // Volta para a opรงรฃo "Selecione..."
            serviceValueInput.value = "";
        }

        // 4. Mostra o modal
        setServiceModal.classList.remove('hidden');
    }
    window.openSetServiceModal = openSetServiceModal; // Torna global

    // Lรณgica de Cancelamento
    document.getElementById('cancelSetService').addEventListener('click', () => {
        setServiceModal.classList.add('hidden');
    });

    // Lรณgica de Submissรฃo do Formulรกrio de Serviรงo
    document.getElementById('setServiceForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const ticketId = document.getElementById('serviceTicketId').value;
        const serviceType = document.getElementById('serviceTypeSelect').value;
        const serviceValue = document.getElementById('serviceValueInput').value.trim();

        if (!ticketId || !serviceType || !serviceValue) {
            alert('Por favor, selecione o serviรงo e defina o valor.');
            return;
        }

        const { error } = await supabaseClient
            .from('tickets')
            .update({ 
                service_type: serviceType, 
                service_value: serviceValue 
            })
            .eq('id', ticketId);

        if (error) {
            alert('Erro ao salvar serviรงo e valor!');
            console.error('Erro ao salvar serviรงo:', error);
        } else {
            alert('Serviรงo e Valor definidos com sucesso!');
            setServiceModal.classList.add('hidden');
            loadAdminDashboard(); // Recarrega a lista para mostrar a atualizaรงรฃo
        }
    });

ย ย // ------------------------------------------------------------------
ย ย // 3. FUNรรES DE MODAIS E FORMULรRIOS
ย ย // ------------------------------------------------------------------

ย ย // FUNรรO CRIAR USUรRIOย
ย ย document.getElementById('createUserForm').addEventListener('submit', async function(e) {
ย ย ย ย e.preventDefault();
ย ย ย ยย
ย ย ย ย const newUsername = document.getElementById('newUsername').value;
ย ย ย ย const newEmail = document.getElementById('newEmail').value;ย
ย ย ย ย const newPassword = document.getElementById('newPassword').value;

ย ย ย ย // 1. Criar o Usuรกrio no Supabase AUTH
ย ย ย ย const { data: authData, error: authError } = await supabaseClient.auth.signUp({
ย ย ย ย ย ย email: newEmail,
ย ย ย ย ย ย password: newPassword,
ย ย ย ย });

ย ย ย ย if (authError) {
ย ย ย ย ย ย alert(`Erro ao criar conta: ${authError.message}`);
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย // 2. Inserir o Perfil (Role) na Tabela 'users'
ย ย ย ย const newUserId = authData.user.id;
ย ย ย ยย
ย ย ย ย const { error: userInsertError } = await supabaseClient
ย ย ย ย ย ย .from('users')
ย ย ย ย ย ย .insert({
ย ย ย ย ย ย ย ย id: newUserId,
ย ย ย ย ย ย ย ย username: newUsername,
ย ย ย ย ย ย ย ย role: 'client' // Define o papel como cliente
ย ย ย ย ย ย });

ย ย ย ย if (userInsertError) {
ย ย ย ย ย ย alert(`Conta criada, mas erro ao definir o perfil (role): ${userInsertError.message}. Limpe o usuรกrio manualmente no Supabase Auth.`);
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย alert(`Usuรกrio cliente "${newUsername}" criado com sucesso! Email de ativaรงรฃo enviado.`);

ย ย ย ย document.getElementById('createUserModal').classList.add('hidden');
ย ย ย ย document.getElementById('createUserForm').reset();
ย ย ย ย loadAdminDashboard(); // Atualiza a contagem de usuรกrios
ย ย });

ย ย // FUNรรO ABRIR NOVO CHAMADO (ATUALIZADA PARA UPLOAD)
ย ย document.getElementById('newTicketForm').addEventListener('submit', async function(e) {
ย ย ย ย e.preventDefault();

ย ย ย ย if (!currentUser || !currentUser.id) {
ย ย ย ย ย ย alert('Vocรช precisa estar logado para abrir um chamado.');
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const requesterName = document.getElementById('requesterName').value;
ย ย ย ย const description = document.getElementById('ticketDescription').value;
ย ย ย ย const attachmentInput = document.getElementById('ticketAttachment');
ย ย ย ย const file = attachmentInput.files[0];
ย ย ย ยย
ย ย ย ย let attachmentUrl = null;
ย ย ย ย const protocol = 'TICKET-' + Date.now().toString().slice(-8) + Math.random().toString(36).substring(2, 6).toUpperCase();

ย ย ย ย // 1. UPLOAD DO ARQUIVO PARA O SUPABASE STORAGE (SE HOUVER ARQUIVO)
ย ย ย ย if (file) {
ย ย ย ย ย ย // Gera um caminho รบnico: client_user_id/protocolo-timestamp.ext
ย ย ย ย ย ย const fileExt = file.name.split('.').pop();
ย ย ย ย ย ย const filePath = `${currentUser.id}/${protocol}-${Date.now()}.${fileExt}`;
ย ย ย ย ย ย const bucketName = 'ticket_attachments';ย
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const { error: uploadError } = await supabaseClient.storage
ย ย ย ย ย ย ย ย ย ย .from(bucketName)
ย ย ย ย ย ย ย ย ย ย .upload(filePath, file, {
ย ย ย ย ย ย ย ย ย ย ย ย cacheControl: '3600',
ย ย ย ย ย ย ย ย ย ย ย ย upsert: falseย
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (uploadError) {
ย ย ย ย ย ย ย ย ย ย throw uploadError;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 2. Obtรฉm a URL pรบblica do arquivo
ย ย ย ย ย ย ย ย const { data: publicUrlData } = supabaseClient.storage
ย ย ย ย ย ย ย ย ย ย .from(bucketName)
ย ย ย ย ย ย ย ย ย ย .getPublicUrl(filePath);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย attachmentUrl = publicUrlData.publicUrl;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย } catch (uploadError) {
ย ย ย ย ย ย ย ย alert(`Erro ao fazer upload do arquivo: ${uploadError.message}. Verifique o Supabase Storage e as polรญticas de RLS.`);
ย ย ย ย ย ย ย ย console.error('Erro de Upload:', uploadError);
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // 3. INSERรรO DO NOVO CHAMADO NO BANCO DE DADOS
ย ย ย ย const { error: insertError } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .insert({
ย ย ย ย ย ย ย ย user_id: currentUser.id,
ย ย ย ย ย ย ย ย requester: requesterName,
ย ย ย ย ย ย ย ย description: description,
ย ย ย ย ย ย ย ย protocol: protocol,
ย ย ย ย ย ย ย ย status: 'open',
ย ย ย ย ย ย ย ย attachment_url: attachmentUrl
ย ย ย ย ย ย });

ย ย ย ย if (insertError) {
ย ย ย ย ย ย alert(`Erro ao enviar chamado: ${insertError.message}`);
ย ย ย ย ย ย console.error('Erro de Inserรงรฃo:', insertError);
ย ย ย ย } else {
ย ย ย ย ย ย alert(`Chamado ${protocol} enviado com sucesso!`);
ย ย ย ย ย ย document.getElementById('newTicketModal').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('newTicketForm').reset();
ย ย ย ย ย ย loadClientDashboard(); // Atualiza a lista de chamados do cliente
ย ย ย ย }
ย ย });

ย ย // ------------------------------------------------------------------
ย ย // 4. FUNรรES DE PDF E TEMA
ย ย // ------------------------------------------------------------------

ย ย // Funรงรฃo auxiliar para gerar um PDF individual de um ticket (Revisada para incluir Serviรงo e Valor)
ย ย async function generateTicketPDF(ticketId) {
ย ย ย ย const { data: ticket, error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .select('*')
ย ย ย ย ย ย .eq('id', ticketId)
ย ย ย ย ย ย .single();

ย ย ย ย if (error) {
ย ย ย ย ย ย alert('Erro ao buscar dados do chamado para PDF.');
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const formattedDate = new Date(ticket.created_at).toLocaleString('pt-BR');
ย ย ย ย const statusText = ticket.status.toUpperCase().replace('_', ' ');
ย ย ย ย const serviceText = ticket.service_type ? `
ย ย ย ย ย ย ย ย ย ย <p><strong>Serviรงo Definido:</strong> ${ticket.service_type}</p>
ย ย ย ย ย ย ย ย ย ย <p><strong>Valor Cobrado:</strong> ${ticket.service_value}</p>
ย ย ย ย ย ย ย ย ย ย ` : `<p><strong>Serviรงo/Valor:</strong> Nรฃo definido</p>`;

ย ย ย ย const content = `
ย ย ย ย ย ย <div style="padding: 20px; font-family: Arial, sans-serif;">
ย ย ย ย ย ย ย ย <h1 style="color: #1e40af;">Relatรณrio de Chamado T.I</h1>
ย ย ย ย ย ย ย ย <hr style="border-top: 1px solid #ccc; margin: 15px 0;">
ย ย ย ย ย ย ย ย <p><strong>Protocolo:</strong> ${ticket.protocol}</p>
ย ย ย ย ย ย ย ย <p><strong>Solicitante:</strong> ${ticket.requester}</p>
ย ย ย ย ย ย ย ย <p><strong>Data de Abertura:</strong> ${formattedDate}</p>
ย ย ย ย ย ย ย ย <p><strong>Status:</strong> ${statusText}</p>
ย ย ย ย ย ย ย ย <hr style="border-top: 1px solid #eee; margin: 15px 0;">
ย ย ย ย ย ย ย ย <h2 style="color: #333; font-size: 1.2em;">Descriรงรฃo</h2>
ย ย ย ย ย ย ย ย <p>${ticket.description}</p>
ย ย ย ย ย ย ย ย <hr style="border-top: 1px solid #eee; margin: 15px 0;">
ย ย ย ย ย ย ย ย <h2 style="color: #333; font-size: 1.2em;">Informaรงรตes de Serviรงo</h2>
ย ย ย ย ย ย ย ย ${serviceText}
ย ย ย ย ย ย ย ย <hr style="border-top: 1px solid #ccc; margin: 15px 0;">
ย ย ย ย ย ย ย ย <p style="font-size: 0.8em; color: #777;">Documento gerado em ${new Date().toLocaleString('pt-BR')}</p>
ย ย ย ย ย ย </div>
ย ย ย ย `;

ย ย ย ย html2pdf().from(content).set({
ย ย ย ย ย ย margin: [10, 10, 10, 10],
ย ย ย ย ย ย filename: `Chamado_${ticket.protocol}.pdf`,
ย ย ย ย ย ย html2canvas: { scale: 2 },
ย ย ย ย ย ย jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
ย ย ย ย }).save();
ย ย }
ย ย window.generateTicketPDF = generateTicketPDF;


ย ย // Funรงรฃo para Gerar Relatรณrio de 30 dias (Mantida)
ย ย // Esta funรงรฃo precisa ser revista para incluir os novos campos 'service_type' e 'service_value' no relatรณrio final.
ย ย // A implementaรงรฃo abaixo รฉ apenas a estrutura original do cรณdigo que vocรช forneceu.
ย ย async function generateMonthlyReport() {
ย ย ย ย const endDate = new Date();
ย ย ย ย const startDate = new Date();
ย ย ย ย startDate.setDate(endDate.getDate() - 30);

ย ย ย ย const { data: tickets, error } = await supabaseClient
ย ย ย ย ย ย .from('tickets')
ย ย ย ย ย ย .select('*')
ย ย ย ย ย ย .gte('created_at', startDate.toISOString())
ย ย ย ย ย ย .lte('created_at', endDate.toISOString())
ย ย ย ย ย ย .order('created_at', { ascending: false });

ย ย ย ย if (error) {
ย ย ย ย ย ย alert('Erro ao carregar dados para o relatรณrio!');
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย let totalValue = 0;
        let tableRows = '';

        tickets.forEach(ticket => {
            const value = parseFloat(ticket.service_value?.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
            if (value > 0) {
                totalValue += value;
            }
            
            // Adiciona a linha na tabela do PDF
            tableRows += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${ticket.protocol}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${ticket.requester}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${ticket.status.toUpperCase().replace('_', ' ')}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${ticket.service_type || 'N/A'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${ticket.service_value || 'R$ 0,00'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${new Date(ticket.created_at).toLocaleDateString('pt-BR')}</td>
                </tr>
            `;
        });

ย ย ย ย const content = `
ย ย ย ย ย ย <div style="padding: 20px; font-family: Arial, sans-serif;">
ย ย ย ย ย ย ย ย <h1 style="color: #1e40af;">Relatรณrio Mensal de Chamados T.I</h1>
ย ย ย ย ย ย ย ย <p>Perรญodo: ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}</p>
ย ย ย ย ย ย ย ย <hr style="border-top: 2px solid #1e40af; margin: 15px 0;">
                <h2 style="color: #333; font-size: 1.5em; margin-bottom: 10px;">Resumo Financeiro</h2>
                <div style="background-color: #f3f4f6; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                    <p style="font-size: 1.2em;"><strong>Valor Total Estimado (Apenas valores fixos):</strong> R$ ${totalValue.toFixed(2).replace('.', ',')}</p>
                    <p style="font-size: 0.9em; color: #555;">(Este valor รฉ uma estimativa. Valores com '+ Valor da peรงa' nรฃo sรฃo somados automaticamente.)</p>
                </div>
                <h2 style="color: #333; font-size: 1.5em; margin-bottom: 10px;">Detalhes dos Chamados (${tickets.length} total)</h2>
ย ย ย ย ย ย ย ย <table style="width: 100%; border-collapse: collapse;">
ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">Protocolo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">Cliente</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">Status</th>
                            <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">Serviรงo</th>
                            <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">Valor</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2; text-align: left;">Data Abertura</th>
ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย <tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ${tableRows}
ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย <p style="font-size: 0.8em; color: #777; margin-top: 20px;">Relatรณrio gerado em ${new Date().toLocaleString('pt-BR')}</p>
ย ย ย ย ย ย </div>
ย ย ย ย `;

ย ย ย ย html2pdf().from(content).set({
ย ย ย ย ย ย margin: [10, 10, 10, 10],
ย ย ย ย ย ย filename: `Relatorio_Mensal_${new Date().getFullYear()}_${new Date().getMonth() + 1}.pdf`,
ย ย ย ย ย ย html2canvas: { scale: 2 },
ย ย ย ย ย ย jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
ย ย ย ย }).save();
ย ย }

ย ย document.getElementById('createUserBtn').addEventListener('click', () => createUserModal.classList.remove('hidden'));
ย ย document.getElementById('cancelCreateUser').addEventListener('click', () => createUserModal.classList.add('hidden'));

ย ย document.getElementById('newTicketBtn').addEventListener('click', () => newTicketModal.classList.remove('hidden'));
ย ย document.getElementById('cancelNewTicket').addEventListener('click', () => newTicketModal.classList.add('hidden'));

ย ย document.getElementById('generateReportBtn').addEventListener('click', () => reportModal.classList.remove('hidden'));
ย ย document.getElementById('cancelReport').addEventListener('click', () => reportModal.classList.add('hidden'));
ย ย document.getElementById('confirmGeneratePDF').addEventListener('click', () => {
ย ย ย ย reportModal.classList.add('hidden');
ย ย ย ย generateMonthlyReport();
ย ย });

ย ย // Alternรขncia de Tema
ย ย themeToggle.addEventListener('click', () => {
ย ย ย ย const isDarkMode = document.body.classList.contains('dark-mode');
ย ย ย ย if (isDarkMode) {
ย ย ย ย ย ย document.body.classList.remove('dark-mode');
ย ย ย ย ย ย document.body.classList.add('light-mode');
ย ย ย ย ย ย themeToggle.textContent = '๐ Modo Escuro';
ย ย ย ย } else {
ย ย ย ย ย ย document.body.classList.remove('light-mode');
ย ย ย ย ย ย document.body.classList.add('dark-mode');
ย ย ย ย ย ย themeToggle.textContent = 'โ๏ธ Modo Claro';
ย ย ย ย }
ย ย });

ย ย checkSession();
</script>
</body>
</html>
